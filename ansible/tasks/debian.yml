---
- name: Install packages
  ansible.builtin.apt:
    pkg:
      - bat # A cat(1) clone with wings.
      - bmon # bandwidth monitor
      - build-essential
      - cloc
      - curl
      - fd-find
      - fzf # command-line fuzzy finder
      - git
      - git-lfs # Git Large File Storage
      - graphviz # e.g. 'dot' command
      - htop
      - httrack # website copier, better than recursive wget
      - imagemagick
      - keychain # re-use ssh-agent and/or gpg-agent between logins
      - libssl-dev
      - ncdu # shows disk usage
      - neovim
      - pass
      - pipx
      - pv # shows progress of data through a pipeline
      - renameutils
      - ripgrep # used, used by fzf
      - shellcheck
      - silversearcher-ag
      - tig
      - tmux
      - tree
      - unzip
      - vim
      - zsh
    update_cache: yes
    state: present
  become: yes

- name: Install snap packages
  community.general.snap:
    name:
      - glances
    state: present
  become: true

- name: Install jrnl using pipx
  ansible.builtin.command: pipx install jrnl
  register: pipx_result
  changed_when: "'installed package' in pipx_result.stdout"
  failed_when: pipx_result.rc != 0

- name: Create .local/bin directory in user's home if it doesn't exist
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.local/bin"
    state: directory
    mode: '0755'
    force: no

- name: Download difftastic archive
  get_url:
    url: https://github.com/Wilfred/difftastic/releases/download/0.61.0/difft-x86_64-unknown-linux-gnu.tar.gz
    dest: /tmp/difft.tar.gz
    mode: '0644'

- name: Extract difftastic binary
  unarchive:
    src: /tmp/difft.tar.gz
    dest: "{{ ansible_env.HOME }}/.local/bin"
    remote_src: yes

- name: Set executable permissions on difft
  file:
    path: "{{ ansible_env.HOME }}/.local/bin/difft"
    mode: '0755'

- name: Clean up downloaded archive
  file:
    path: /tmp/difft.tar.gz
    state: absent

- name: Create symbolic link for bat
  ansible.builtin.file:
    src: /usr/bin/batcat
    dest: "{{ ansible_env.HOME }}/.local/bin/bat"
    state: link

- name: Get fdfind path
  ansible.builtin.command:
    cmd: which fdfind
  register: fdfind_path
  changed_when: false
  check_mode: no

- name: Create symbolic link for fd
  ansible.builtin.file:
    src: "{{ fdfind_path.stdout }}"
    dest: "{{ ansible_env.HOME }}/.local/bin/fd"
    state: link

- name: Generate en_US.UTF-8 locale
  locale_gen:
    name: en_US.UTF-8
    state: present

- name: Ensure default shell is zsh for "{{ ansible_user_id }}"
  ansible.builtin.user:
    name: "{{ ansible_user_id }}"
    shell: /usr/bin/zsh
  become: true
